<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Fretboard Trainer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Guitar Fretboard Trainer</h1>
        
        <div id="instructions-tooltip" class="instructions-tooltip hidden">
            <h3>How to Use</h3>
            <div class="instructions-content">
                <p><strong>Goal:</strong> Learn the notes on the guitar fretboard.</p>
                
                <div class="feature-highlight">
                    <p><span class="tip-icon">üí°</span> <strong>Key Controls:</strong></p>
                    <ul>
                        <li>Press <kbd>Spacebar</kbd> to play the current note</li>
                        <li>Click the <strong>üîä</strong> button to hear the note</li>
                    </ul>
                </div>
                
                <ul>
                    <li>A note is highlighted on the fretboard.</li>
                    <li>Select the correct note name from the answer buttons.</li>
                    <li>Your score is tracked at the bottom of the screen.</li>
                </ul>
                
                <div class="feature-highlight">
                    <p><span class="tip-icon">üéµ</span> <strong>Change Sharp/Flat Display:</strong></p>
                    <p>Look for the <strong>Circle of Fifths</strong> in the bottom-right corner. Click on any note with a <span style="color:#ff6666">red border</span> to toggle between sharp (‚ôØ) and flat (‚ô≠) notation (e.g., C‚ôØ/D‚ô≠).</p>
                </div>
                
                <p><strong>Settings:</strong> Customize your practice by changing the options in the settings panel at the top.</p>
            </div>
        </div>

        <div id="orientation-popup" class="orientation-popup hidden">
            <div class="orientation-content">
                <div class="rotate-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
                        <path fill="currentColor" d="M16.5 2.5l3 3-3 3v-2h-10v4h2v-2h8v2l3-3-3-3v2h-8v-2h-2v4h10v-2h2v-2z"/>
                        <path fill="currentColor" d="M10 13H2v9h16v-9h-8zm7 8H3v-7h14v7z"/>
                    </svg>
                </div>
                <h3>Please Rotate Your Device</h3>
                <p>This app works best in landscape mode for better visualization of the guitar fretboard.</p>
            </div>
        </div>

        <div class="fretboard-container">
            <div id="fretboard" class="fretboard"></div>
            <div class="controls-row">
                <button id="soundButton" title="Play Sound (Spacebar)">üîä</button>
                <div id="answer-buttons" class="buttons">
                    <!-- Buttons will be created dynamically -->
                </div>
            </div>
            <div id="feedback"></div>
        </div>

        <div id="progress">
            Correct: <span id="correct">0</span> |
            Total: <span id="total">0</span> |
            Percentage: <span id="percentage">0%</span><br>
            <button id="reset-score">Reset Score</button>
        </div>

        <div id="circle-of-fifths-tooltip" class="circle-of-fifths-tooltip hidden">
            <h3>Circle of Fifths</h3>
            <div id="circle-container"></div>
            <div class="circle-instructions">
                <p>Click on sharps/flats to toggle notation style</p>
            </div>
        </div>

        <div class="theme-toggle-container">
            <button id="theme-toggle" class="theme-toggle" title="Toggle Light/Dark Mode">
                <span class="theme-icon">üåï</span>
            </button>
            <button id="cof-toggle-button" class="theme-toggle" title="Show Circle of Fifths (Press C)">
                <span class="cof-icon">üéµ</span>
            </button>
        </div>

        <a href="https://github.com/gWOLF3/guitartrainer" target="_blank" class="github-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
</svg>
            <span>Open Source on GitHub</span>
        </a>
    </div>

    <div class="header-control settings-button-container">
        <button id="settings-toggle-button" class="icon-button" title="Settings (S)">‚öôÔ∏è</button>
    </div>

    <div id="settings-popup" class="settings-popup hidden">
        <div id="settings-header" class="popup-header">
            <h3>Settings</h3>
        </div>
        <div id="settings-container">
            <div class="options" style="display: block;">
                <div id="settings-content" class="settings-content" style="display: block; max-height: none;">
                    Fret Range: 
                    <input type="number" id="minFret" min="0" max="16" value="0"> to 
                    <input type="number" id="maxFret" min="0" max="16" value="16"><br><br>
                    
                    Strings: 
                    <label><input type="checkbox" class="string" value="0" checked>E (high)</label>
                    <label><input type="checkbox" class="string" value="1" checked>B</label>
                    <label><input type="checkbox" class="string" value="2" checked>G</label>
                    <label><input type="checkbox" class="string" value="3" checked>D</label>
                    <label><input type="checkbox" class="string" value="4" checked>A</label>
                    <label><input type="checkbox" class="string" value="5" checked>E (low)</label><br><br>
                    
                    <div class="mode-selection">
                        <div class="mode-header">Mode:</div>
                        
                        <div class="mode-option">
                            <label><input type="radio" name="mode" id="noteMode" value="note" checked> Note</label>
                            <div id="noteTypes" class="submenu" style="display: block;">
                                <div class="submenu-content">
                                    <div class="submenu-section">
                                        <span class="submenu-label">Note Types:</span>
                                        <label><input type="checkbox" id="naturals" checked>Naturals</label>
                                        <label><input type="checkbox" id="sharpsFlats" checked>Sharps/Flats</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mode-option">
                            <label><input type="radio" name="mode" id="triadMode" value="triad"> Triad</label>
                            <div id="triadInversions" class="submenu" style="display: block;">
                                <div class="submenu-content">
                                    <div class="submenu-section">
                                        <span class="submenu-label">Inversions:</span>
                                        <label><input type="checkbox" id="rootPosition" checked> Root Position</label>
                                        <label><input type="checkbox" id="firstInversion" checked> First Inversion</label>
                                        <label><input type="checkbox" id="secondInversion" checked> Second Inversion</label>
                                    </div>
                                    <div class="submenu-section">
                                        <span class="submenu-label">Triad Types:</span>
                                        <label><input type="checkbox" id="majorTriads" checked> Major</label>
                                        <label><input type="checkbox" id="minorTriads" checked> Minor</label>
                                        <label><input type="checkbox" id="diminishedTriads"> Diminished</label>
                                        <label><input type="checkbox" id="augmentedTriads"> Augmented</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="fretboard.js"></script>
    <script src="circleOfFifths.js"></script>
    <script src="sound.js"></script>
    <script src="triads.js"></script>
    <script src="app.js"></script>
    <script>
        const notes = noteUtils.allNotes.map(note => noteUtils.getDisplayPreference(note));
        const stringTunings = ['E', 'B', 'G', 'D', 'A', 'E'];
        let currentString, currentFret, correctNote, currentChord, correctChordName;
        let waitingForConfirmation = false;

        // Create a global shared AudioContext
        let sharedAudioContext;

        // Initialize AudioContext on first user interaction
        function initAudioContext() {
            if (!sharedAudioContext) {
                try {
                    sharedAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContext initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize AudioContext:', error);
                }
            } else if (sharedAudioContext.state === 'suspended') {
                sharedAudioContext.resume();
            }
            return sharedAudioContext;
        }

        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            return parts.length === 2 ? parts.pop().split(';').shift() : null;
        }

        function loadSettings() {
            ['naturals', 'sharpsFlats', 'rootPosition', 'firstInversion', 'secondInversion'].forEach(id => {
                const value = getCookie(id);
                if (value !== null) document.getElementById(id).checked = value === 'true';
            });
            ['minFret', 'maxFret'].forEach(id => {
                const value = getCookie(id);
                if (value !== null) document.getElementById(id).value = value;
            });
            ['noteMode', 'triadMode'].forEach(id => {
                const value = getCookie(id);
                if (value !== null) document.getElementById(id).checked = value === 'true';
            });
            document.querySelectorAll('.string').forEach(cb => {
                const value = getCookie(`string_${cb.value}`);
                if (value !== null) cb.checked = value === 'true';
            });
        }

        function saveSettings() {
            ['naturals', 'sharpsFlats', 'rootPosition', 'firstInversion', 'secondInversion', 
             'majorTriads', 'minorTriads', 'diminishedTriads', 'augmentedTriads'].forEach(id => {
                setCookie(id, document.getElementById(id).checked, 30);
            });
            ['minFret', 'maxFret'].forEach(id => {
                setCookie(id, document.getElementById(id).value, 30);
            });
            ['noteMode', 'triadMode'].forEach(id => {
                setCookie(id, document.getElementById(id).checked, 30);
            });
            document.querySelectorAll('.string').forEach(cb => {
                setCookie(`string_${cb.value}`, cb.checked, 30);
            });
        }

        function loadProgress() {
            const correct = getCookie('correct') || '0';
            const total = getCookie('total') || '0';
            document.getElementById('correct').textContent = correct;
            document.getElementById('total').textContent = total;
            document.getElementById('percentage').textContent = total == 0 ? '0%' : `${Math.round((correct / total) * 100)}%`;
        }

        function resetScore() {
            setCookie('correct', '0', 30);
            setCookie('total', '0', 30);
            loadProgress();
        }

        function getRandomNote() {
            // First, get the filtered note pool based on study mode
            const notePool = noteUtils.getNotesForStudyMode();
            console.log("Note pool from study mode:", notePool);
            
            // Get fret range and selected strings
            const minFret = parseInt(document.getElementById('minFret').value);
            const maxFret = parseInt(document.getElementById('maxFret').value);
            const strings = Array.from(document.querySelectorAll('.string:checked')).map(cb => parseInt(cb.value));
            
            if (strings.length === 0) {
                alert('Please select at least one string.');
                document.querySelector('.string[value="0"]').checked = true;
                strings.push(0);
            }
            
            // Find all valid positions that produce notes from our filtered pool
            const validPositions = [];
            
            for (let stringIndex of strings) {
                const stringNote = stringTunings[stringIndex];
                const stringNoteIndex = notes.indexOf(stringNote);
                
                for (let fret = minFret; fret <= maxFret; fret++) {
                    const noteIndex = (stringNoteIndex + fret) % 12;
                    const noteAtPosition = notes[noteIndex];
                    
                    // Check if this note is in our filtered pool or equivalent to one in the pool
                    if (notePool.includes(noteAtPosition) || 
                        notePool.some(note => noteUtils.areEquivalent(note, noteAtPosition))) {
                        validPositions.push({string: stringIndex, fret: fret});
                    }
                }
            }
            
            if (validPositions.length === 0) {
                alert("No notes matching your study mode can be found in the current fret range. Adjusting settings...");
                // Reset to all notes if we can't find anything
                document.getElementById('naturalNotesOnly').checked = false;
                document.getElementById('accidentalsOnly').checked = false;
                getRandomNote();
                return;
            }
            
            // Pick a random valid position
            const randomPosition = validPositions[Math.floor(Math.random() * validPositions.length)];
            currentString = randomPosition.string;
            currentFret = randomPosition.fret;
            
            // Get the canonical form of the note at this position
            const stringNoteIndex = notes.indexOf(stringTunings[currentString]);
            const noteIndex = (stringNoteIndex + currentFret) % 12;
            correctNote = notes[noteIndex];
            
            renderFretboard();
            document.getElementById('feedback').textContent = '';
            generateAnswerButtons();
            document.querySelectorAll('.note-display').forEach(el => el.remove());
        }

        function generateAnswerButtons() {
            const buttonsDiv = document.getElementById('answer-buttons');
            buttonsDiv.innerHTML = '';
            const isTriadMode = document.getElementById('triadMode').checked;
            const correctAnswer = isTriadMode ? correctChordName : correctNote;
            const options = isTriadMode ? generateTriadAnswerOptions(correctAnswer) : generateNoteAnswerOptions(correctAnswer);
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.disabled = false;
                button.addEventListener('click', () => checkAnswer(option, correctAnswer));
                buttonsDiv.appendChild(button);
            });
            
            waitingForConfirmation = false;
        }

        function generateNoteAnswerOptions(correctNote) {
            // Get the canonical form of the correct note
            const canonicalCorrect = getCanonicalForm(correctNote);
            
            // Get available notes based on study mode
            const notePool = noteUtils.getNotesForStudyMode();
            
            // CRITICAL FIX: Check if the correct note is actually in the study pool
            // If not, we need to select a new correct note from the pool
            if (!notePool.includes(canonicalCorrect) && 
                !notePool.some(note => noteUtils.areEquivalent(note, canonicalCorrect))) {
                // The correct note isn't in our study pool! Get a new one from the pool
                const randomIndex = Math.floor(Math.random() * notePool.length);
                correctNote = notePool[randomIndex];
                
                // Update global correct note
                window.correctNote = correctNote;
                
                // Reposition on fretboard
                const stringFretCombinations = findNoteLocations(correctNote);
                const position = selectRandomLocation(stringFretCombinations);
                currentString = position.string;
                currentFret = position.fret;
                renderFretboard();
            }
            
            // Create answer choices using the filtered note pool
            let choices = [canonicalCorrect]; // Start with correct answer
            
            // Add random incorrect answers from the note pool
            while (choices.length < 4) {
                const randomNote = notePool[Math.floor(Math.random() * notePool.length)];
                if (!choices.some(note => noteUtils.areEquivalent(note, randomNote))) {
                    choices.push(randomNote);
                }
            }
            
            // Shuffle and apply display preferences 
            return noteUtils.shuffleArray(choices).map(note => noteUtils.getDisplayPreference(note));
        }

        function generateTriadAnswerOptions(correctChord) {
            const options = [correctChord];
            
            // Get available triad types for generating options
            const availableTriadTypes = getAvailableTriadTypes();
            const cleanNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            // Get available inversions
            const inversions = [];
            if (document.getElementById('rootPosition').checked) inversions.push(0);
            if (document.getElementById('firstInversion').checked) inversions.push(1);
            if (document.getElementById('secondInversion').checked) inversions.push(2);
            
            // Create wrong options until we have 4 total options
            while (options.length < 4) {
                // Random note
                const note = cleanNotes[Math.floor(Math.random() * cleanNotes.length)];
                
                // Random triad type
                const type = availableTriadTypes[Math.floor(Math.random() * availableTriadTypes.length)];
                
                // Format a fake chord name
                let wrongOption = `${note}${triads[type].symbol}`;
                
                // Only add slash notation if the correct answer has it
                if (correctChord.includes('/')) {
                    // Get a random inversion that matches our selected inversions
                    const inversion = inversions[Math.floor(Math.random() * inversions.length)];
                    
                    // Calculate the bass note based on the inversion
                    const intervals = triads[type].intervals;
                    const rootIndex = cleanNotes.indexOf(note);
                    const bassNoteIndex = (rootIndex + intervals[inversion]) % 12;
                    const bassNote = cleanNotes[bassNoteIndex];
                    
                    wrongOption += `/${bassNote}`;
                }
                
                // Add to options if not already included
                if (!options.includes(wrongOption)) {
                    options.push(wrongOption);
                }
            }
            
            // Shuffle the options
            return options.sort(() => Math.random() - 0.5);
        }

        function checkAnswer(selected, correct) {
            // Prevent processing if we're already waiting for confirmation
            if (waitingForConfirmation) return;
            
            const feedback = document.getElementById('feedback');
            const isCorrect = noteUtils.areEquivalent(getCanonicalForm(selected), getCanonicalForm(correct));
            
            // Remove text feedback and just rely on visual cues
            feedback.textContent = '';
            
            playFeedbackSound(isCorrect);
            
            // Update the score
            const correctCount = parseInt(document.getElementById('correct').textContent) + (isCorrect ? 1 : 0);
            const totalCount = parseInt(document.getElementById('total').textContent) + 1;
            setCookie('correct', correctCount, 30);
            setCookie('total', totalCount, 30);
            loadProgress();
            
            if (isCorrect) {
                // Find and highlight the button that was clicked
                const buttons = document.querySelectorAll('#answer-buttons button');
                buttons.forEach(button => {
                    if (button.textContent.trim() === selected.trim()) {
                        button.classList.add('correct-answer-highlight');
                    }
                });
                
                // If correct, proceed to next question after delay
                setTimeout(() => {
                    // Remove any highlights before moving on
                    document.querySelectorAll('.correct-answer-highlight').forEach(el => {
                        el.classList.remove('correct-answer-highlight');
                    });
                    document.getElementById('triadMode').checked ? getRandomTriad() : getRandomNote();
                }, 1000);
            } else {
                // Set state flag to prevent multiple triggers
                waitingForConfirmation = true;
                
                // If wrong, highlight the correct answer and wait for user to click it
                const answerButtons = document.querySelectorAll('#answer-buttons button');
                
                // Update all buttons
                answerButtons.forEach(button => {
                    // Normalize strings for comparison by trimming whitespace
                    const buttonText = button.textContent.trim();
                    const correctText = correct.trim();
                    
                    if (buttonText === correctText) {
                        // Highlight correct answer
                        button.classList.add('correct-answer');
                        
                        // Create a one-time event listener
                        button.addEventListener('click', function continueHandler() {
                            // Remove event listener to prevent multiple triggers
                            button.removeEventListener('click', continueHandler);
                            
                            // Remove highlighting
                            button.classList.remove('correct-answer');
                            
                            // Reset waiting state
                            waitingForConfirmation = false;
                            
                            // Move to next question
                            document.getElementById('triadMode').checked ? getRandomTriad() : getRandomNote();
                        });
                    } else {
                        // Disable incorrect buttons
                        button.disabled = true;
                    }
                });
            }

            // After the answer is checked, show the notes on the fretboard
            showNotesOnFretboard();
        }

        function updateModeSubmenus() {
            const noteTypes = document.getElementById('noteTypes');
            const triadInversions = document.getElementById('triadInversions');
            
            if (document.getElementById('noteMode').checked) {
                noteTypes.style.display = 'block';
                triadInversions.style.display = 'block';
            } else {
                noteTypes.style.display = 'block';
                triadInversions.style.display = 'block';
            }
        }

        loadSettings();
        updateModeSubmenus();
        loadProgress();
        renderFretboard();
        renderCircleOfFifths();
        document.getElementById('circle-of-fifths-tooltip').style.display = 'block';

        document.querySelectorAll('input[type="radio"]').forEach(input => {
            input.addEventListener('change', () => {
                const isTriadMode = document.getElementById('triadMode').checked;
                updateModeSubmenus();
                if (isTriadMode) getRandomTriad();
                else getRandomNote();
                saveSettings();
            });
        });

        document.querySelectorAll('input:not([type="radio"])').forEach(input => {
            input.addEventListener('change', () => {
                const isTriadMode = document.getElementById('triadMode').checked;
                if (isTriadMode) getRandomTriad();
                else getRandomNote();
                saveSettings();
            });
        });

        document.getElementById('soundButton').addEventListener('click', playChordOrNote);
        document.getElementById('reset-score').addEventListener('click', resetScore);

        function playChordOrNote() {
            const isTriadMode = document.getElementById('triadMode').checked;
            
            if (isTriadMode && currentChord) {
                // For triads, highlight all chord positions
                currentChord.forEach(position => {
                    const [string, fret] = position;
                    let fretElement;
                    
                    if (fret === 0) {
                        // For open strings, just use the .open class
                        fretElement = document.querySelector(`.string[data-string="${string}"] .open`);
                    } else {
                        // For regular frets
                        fretElement = document.querySelector(`.string[data-string="${string}"] .fret[data-fret="${fret}"]`);
                    }
                    
                    if (fretElement) {
                        fretElement.classList.add('playing');
                        setTimeout(() => fretElement.classList.remove('playing'), 500);
                    }
                });
                playChord(currentChord);
            } else {
                // For single notes
                let fretElement;
                
                if (currentFret === 0) {
                    // For open strings, just use the .open class
                    fretElement = document.querySelector(`.string[data-string="${currentString}"] .open`);
                } else {
                    // For regular frets
                    fretElement = document.querySelector(`.string[data-string="${currentString}"] .fret[data-fret="${currentFret}"]`);
                }
                
                if (fretElement) {
                    fretElement.classList.add('playing');
                    setTimeout(() => fretElement.classList.remove('playing'), 500);
                }
                
                playNote(currentString, currentFret);
            }
        }

        window.addEventListener('resize', debounce(() => {
            renderFretboard();
            renderCircleOfFifths();
        }, 200));

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        if (document.getElementById('triadMode').checked) {
            getRandomTriad();
        } else {
            getRandomNote();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Setup settings collapse toggle
            document.getElementById('toggle-settings').addEventListener('click', function() {
                const options = document.querySelector('.options');
                options.classList.toggle('collapsed');
                
                // Save the state
                setCookie('settings-collapsed', options.classList.contains('collapsed'), 30);
            });
            
            // Auto-collapse settings when clicking on the fretboard
            document.getElementById('fretboard').addEventListener('click', function() {
                const options = document.querySelector('.options');
                if (!options.classList.contains('collapsed')) {
                    options.classList.add('collapsed');
                    setCookie('settings-collapsed', true, 30);
                }
            });
            
            // Load settings collapse state
            const settingsCollapsed = getCookie('settings-collapsed');
            if (settingsCollapsed === 'true') {
                document.querySelector('.options').classList.add('collapsed');
            }
            
            // Adjust instructions tooltip behavior
            document.getElementById('help-button').addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent document click from immediately closing it
                document.getElementById('instructions-tooltip').classList.toggle('hidden');
            });
            
            document.getElementById('instructions-close').addEventListener('click', function() {
                document.getElementById('instructions-tooltip').classList.add('hidden');
            });
            
            // Close instructions when clicking outside
            document.addEventListener('click', function(event) {
                const tooltip = document.getElementById('instructions-tooltip');
                const helpButton = document.getElementById('help-button');
                
                if (!tooltip.contains(event.target) && event.target !== helpButton) {
                    tooltip.classList.add('hidden');
                }
            });
            
            // Clean Circle of Fifths implementation
            console.log('Setting up Circle of Fifths...');
            
            // Get elements
            const cofTooltip = document.getElementById('circle-of-fifths-tooltip');
            const cofToggleButton = document.getElementById('cof-toggle-button');
            
            // Important: Remove any inline styles that might be conflicting
            if (cofTooltip) {
                cofTooltip.removeAttribute('style');
                cofTooltip.classList.add('hidden');
            }
            
            // Toggle function
            function toggleCoF(event) {
                if (event) {
                    event.stopPropagation();
                }
                
                const isHidden = cofTooltip.classList.contains('hidden');
                console.log('Toggling Circle of Fifths, currently hidden:', isHidden);
                
                if (isHidden) {
                    // Show it
                    cofTooltip.classList.remove('hidden');
                    
                    // Render the content
                    setTimeout(function() {
                        if (typeof renderCircleOfFifths === 'function') {
                            console.log('Rendering Circle of Fifths');
                            renderCircleOfFifths();
                        }
                    }, 50);
                } else {
                    // Hide it
                    cofTooltip.classList.add('hidden');
                }
            }
            
            // Add event listeners
            if (cofToggleButton) {
                // Remove any existing event listeners (clone and replace)
                const newButton = cofToggleButton.cloneNode(true);
                cofToggleButton.parentNode.replaceChild(newButton, cofToggleButton);
                newButton.addEventListener('click', toggleCoF);
                console.log('Toggle button event listener added');
            }
            
            // Global keyboard shortcut
            document.addEventListener('keydown', function(event) {
                if ((event.key === 'c' || event.key === 'C') && 
                    document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    event.preventDefault();
                    toggleCoF();
                }
            });
            
            // Click outside to close
            document.addEventListener('click', function(event) {
                if (!cofTooltip.classList.contains('hidden') &&
                    !cofTooltip.contains(event.target) && 
                    event.target !== cofToggleButton) {
                    cofTooltip.classList.add('hidden');
                }
            });
            
            console.log('Circle of Fifths setup complete');
        });

        document.addEventListener('keydown', function(event) {
            // Check if the pressed key is the spacebar
            if (event.key === ' ' || event.code === 'Space') {
                // Prevent default spacebar behavior (scrolling)
                event.preventDefault();
                // Play the current note or chord
                playChordOrNote();
            }
        });

        // Enhanced function to properly redraw the Circle of Fifths
        function forceCircleRedraw() {
            const tooltip = document.getElementById('circle-of-fifths-tooltip');
            const circleContainer = document.getElementById('circle-container');
            
            // First clear the container
            if (circleContainer) {
                circleContainer.innerHTML = '';
            }
            
            // Then force redraw with multiple attempts
            // Try immediately
            if (typeof renderCircleOfFifths === 'function') {
                try {
                    renderCircleOfFifths();
                    console.log('Circle of Fifths rendered successfully');
                } catch (e) {
                    console.error('Error rendering Circle of Fifths:', e);
                    
                    // Fallback content if rendering fails
                    circleContainer.innerHTML = '<div style="padding: 20px; text-align: center;">' +
                        '<p>Unable to display Circle of Fifths.</p>' +
                        '<p>Please refresh the page and try again.</p></div>';
                }
            } else {
                console.error('renderCircleOfFifths function not found');
                circleContainer.innerHTML = '<div style="padding: 20px; text-align: center;">' +
                    '<p>Circle of Fifths rendering function not available.</p></div>';
            }
        }

        // Add this function to display note names on the fretboard after answering
        function showNotesOnFretboard() {
            // Clear any existing note displays first
            document.querySelectorAll('.note-display').forEach(el => el.remove());
            
            if (!document.getElementById('triadMode').checked) {
                // Single note mode
                let fretElement;
                
                if (currentFret === 0) {
                    // For open string in single note mode
                    fretElement = document.querySelector(`.string[data-string="${currentString}"] .fret.open`);
                } else {
                    // For regular frets in single note mode
                    fretElement = document.querySelector(`.string[data-string="${currentString}"] .fret[data-fret="${currentFret}"]`);
                }
                
                if (fretElement) {
                    showNoteNameOnElement(fretElement, currentString, currentFret);
                }
            } else if (currentChord) {
                // Triad mode - show all three notes
                currentChord.forEach(position => {
                    const [string, fret] = position;
                    let fretElement;
                    
                    if (fret === 0) {
                        // For open strings in triad mode
                        fretElement = document.querySelector(`.string[data-string="${string}"] .fret.open`);
                    } else {
                        // For regular frets in triad mode
                        fretElement = document.querySelector(`.string[data-string="${string}"] .fret[data-fret="${fret}"]`);
                    }
                    
                    if (fretElement) {
                        showNoteNameOnElement(fretElement, string, fret);
                    }
                });
            }
        }

        // Helper function to display a note name on a fretboard element
        function showNoteNameOnElement(element, string, fret) {
            const stringTuning = stringTunings[string];
            const stringTuningIndex = noteUtils.allNotes.indexOf(stringTuning);
            const noteIndex = (stringTuningIndex + fret) % 12;
            const noteName = noteUtils.getDisplayPreference(noteUtils.allNotes[noteIndex]);
            
            const noteDisplay = document.createElement('div');
            noteDisplay.className = 'note-display';
            noteDisplay.textContent = noteName;
            element.appendChild(noteDisplay);
        }

        // Add these event handlers to the inversion checkboxes
        document.getElementById('rootPosition').addEventListener('change', function() {
            if (document.getElementById('triadMode').checked) {
                getRandomTriad();
            }
        });

        document.getElementById('firstInversion').addEventListener('change', function() {
            if (document.getElementById('triadMode').checked) {
                getRandomTriad();
            }
        });

        document.getElementById('secondInversion').addEventListener('change', function() {
            if (document.getElementById('triadMode').checked) {
                getRandomTriad();
            }
        });

        // Check if device is mobile 
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 800);
        }

        // Check if orientation is portrait
        function isPortrait() {
            return window.innerHeight > window.innerWidth;
        }

        // Show or hide orientation popup based on device type and orientation
        function checkOrientation() {
            const orientationPopup = document.getElementById('orientation-popup');
            
            if (isMobileDevice() && isPortrait()) {
                // Show popup and prevent scrolling
                orientationPopup.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                console.log('Showing orientation popup - portrait detected');
            } else {
                // Hide popup and allow scrolling
                orientationPopup.classList.add('hidden');
                document.body.style.overflow = '';
                console.log('Hiding orientation popup - landscape detected');
                
                // Force a redraw of the fretboard after orientation change
                setTimeout(() => {
                    if (typeof renderFretboard === 'function') {
                        renderFretboard();
                    }
                    if (typeof renderCircleOfFifths === 'function') {
                        renderCircleOfFifths();
                    }
                }, 300);
            }
        }

        // Check orientation on page load and whenever orientation might change
        document.addEventListener('DOMContentLoaded', checkOrientation);
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', checkOrientation);

        // For iOS devices, which might not properly trigger orientation events
        window.addEventListener('orientationchange', () => {
            setTimeout(checkOrientation, 200); // Small delay to ensure dimensions have updated
        });

        // Run the check immediately
        checkOrientation();
        console.log('Orientation detection initialized');

        // Fix Circle of Fifths rendering issues
        function fixCircleOfFifthsRendering() {
            // Define a proper rendering function that ensures correct sizing
            window.renderCircleOfFifthsFixed = function() {
                console.log('Running enhanced Circle of Fifths rendering');
                
                const container = document.getElementById('circle-container');
                if (!container) {
                    console.error('Circle container not found');
                    return;
                }
                
                // Clear existing content
                container.innerHTML = '';
                
                // Set explicit dimensions for the container
                container.style.width = '300px';
                container.style.height = '300px';
                container.style.position = 'relative';
                
                // Force layout recalculation
                container.offsetHeight; // This triggers a reflow
                
                // Now render the circle of fifths
                const size = 300; // Use fixed size instead of container dimensions
                const radius = size / 2;
                
                circleKeys.forEach(key => {
                    const angleRad = (key.angle * Math.PI) / 180;
                    const x = radius + (radius * 0.7) * Math.cos(angleRad);
                    const y = radius + (radius * 0.7) * Math.sin(angleRad);
                    
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'circle-key';
                    keyDiv.textContent = getCookie(`circle_${key.key}`) || key.key;
                    if (key.alt) keyDiv.classList.add('sharp-flat');
                    
                    // Position the key element
                    keyDiv.style.position = 'absolute';
                    keyDiv.style.left = `${x}px`;
                    keyDiv.style.top = `${y}px`;
                    keyDiv.style.transform = 'translate(-50%, -50%)';
                    keyDiv.style.width = '40px';
                    keyDiv.style.height = '40px';
                    keyDiv.style.borderRadius = '50%';
                    keyDiv.style.display = 'flex';
                    keyDiv.style.alignItems = 'center';
                    keyDiv.style.justifyContent = 'center';
                    keyDiv.style.background = 'var(--accent-color)';
                    keyDiv.style.color = 'var(--tooltip-bg)';
                    keyDiv.style.fontWeight = 'bold';
                    keyDiv.style.cursor = 'pointer';
                    keyDiv.style.zIndex = '2';
                    
                    keyDiv.addEventListener('click', () => {
                        if (key.alt) {
                            const current = keyDiv.textContent;
                            const newKey = current === key.key ? key.alt : key.key;
                            keyDiv.textContent = newKey;
                            
                            // Store preference in cookie
                            const canonicalKey = key.key.includes('#') ? key.key : (key.alt || key.key);
                            setCookie(`circle_${canonicalKey}`, newKey, 30);
                            
                            // Update any displayed notes if needed
                            if (typeof updateDisplayedNotes === 'function') {
                                updateDisplayedNotes();
                            }
                        }
                    });
                    
                    container.appendChild(keyDiv);
                });
                
                // Draw center circle
                const centerCircle = document.createElement('div');
                centerCircle.style.position = 'absolute';
                centerCircle.style.left = '50%';
                centerCircle.style.top = '50%';
                centerCircle.style.transform = 'translate(-50%, -50%)';
                centerCircle.style.width = '80px';
                centerCircle.style.height = '80px';
                centerCircle.style.borderRadius = '50%';
                centerCircle.style.border = '2px solid var(--accent-color)';
                centerCircle.style.zIndex = '1';
                container.appendChild(centerCircle);
                
                // Draw outer circle
                const outerCircle = document.createElement('div');
                outerCircle.style.position = 'absolute';
                outerCircle.style.left = '50%';
                outerCircle.style.top = '50%';
                outerCircle.style.transform = 'translate(-50%, -50%)';
                outerCircle.style.width = '240px';
                outerCircle.style.height = '240px';
                outerCircle.style.borderRadius = '50%';
                outerCircle.style.border = '2px solid var(--accent-color)';
                outerCircle.style.zIndex = '1';
                container.appendChild(outerCircle);
                
                console.log('Circle of Fifths rendering complete');
            };
            
            // Override the original rendering function
            window.originalRenderCircleOfFifths = window.renderCircleOfFifths;
            window.renderCircleOfFifths = window.renderCircleOfFifthsFixed;
            
            // Update the toggle function to use our fixed renderer
            const toggleCoF = function(event) {
                if (event) {
                    event.stopPropagation();
                }
                
                const cofTooltip = document.getElementById('circle-of-fifths-tooltip');
                const isHidden = cofTooltip.classList.contains('hidden');
                
                if (isHidden) {
                    cofTooltip.classList.remove('hidden');
                    
                    // Use the fixed rendering function
                    setTimeout(function() {
                        if (typeof renderCircleOfFifthsFixed === 'function') {
                            renderCircleOfFifthsFixed();
                        }
                    }, 50);
                } else {
                    cofTooltip.classList.add('hidden');
                }
            };
            
            // Update event listeners to use the new toggle function
            const cofToggleButton = document.getElementById('cof-toggle-button');
            if (cofToggleButton) {
                const newButton = cofToggleButton.cloneNode(true);
                cofToggleButton.parentNode.replaceChild(newButton, cofToggleButton);
                newButton.addEventListener('click', toggleCoF);
            }
            
            // Also update the keyboard shortcut
            document.addEventListener('keydown', function(event) {
                if ((event.key === 'c' || event.key === 'C') && 
                    document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    event.preventDefault();
                    toggleCoF();
                }
            });
            
            console.log('Circle of Fifths rendering fixed');
        }

        // Run the fix immediately
        fixCircleOfFifthsRendering();

        // Fix the missing keyboard shortcut for Circle of Fifths
        (function() {
            console.log('Setting up Circle of Fifths keyboard shortcut...');
            
            // Remove any existing keyboard listeners (which is hard to do directly)
            // Instead, we'll create a single, high-priority handler
            
            document.addEventListener('keydown', function(event) {
                // For Circle of Fifths - "C" key
                if ((event.key === 'c' || event.key === 'C') && 
                    document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    
                    console.log('Circle of Fifths keyboard shortcut detected');
                    event.preventDefault();
                    
                    // Get the tooltip element
                    const cofTooltip = document.getElementById('circle-of-fifths-tooltip');
                    if (!cofTooltip) {
                        console.error('Circle of Fifths tooltip not found');
                        return;
                    }
                    
                    // Toggle visibility
                    const isHidden = cofTooltip.classList.contains('hidden');
                    console.log('Current visibility state:', isHidden ? 'hidden' : 'visible');
                    
                    if (isHidden) {
                        cofTooltip.classList.remove('hidden');
                        
                        // Render the circle
                        setTimeout(function() {
                            if (typeof renderCircleOfFifthsFixed === 'function') {
                                console.log('Rendering with fixed function');
                                renderCircleOfFifthsFixed();
                            } else if (typeof renderCircleOfFifths === 'function') {
                                console.log('Rendering with original function');
                                renderCircleOfFifths();
                            } else {
                                console.error('No rendering function available');
                            }
                        }, 50);
                    } else {
                        cofTooltip.classList.add('hidden');
                    }
                }
                
                // Keep spacebar functionality for playing notes
                if ((event.key === ' ' || event.code === 'Space') && 
                    document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    event.preventDefault();
                    if (typeof playChordOrNote === 'function') {
                        playChordOrNote();
                    }
                }
            }, true); // Use capturing phase to ensure this handler runs first
            
            console.log('Circle of Fifths keyboard shortcut setup complete');
        })();

        // Updated Settings Popup functionality
        (function() {
            console.log('Setting up simplified Settings popup...');
            
            // Get references to elements
            const settingsToggleButton = document.getElementById('settings-toggle-button');
            const settingsPopup = document.getElementById('settings-popup');
            
            // Function to toggle settings popup visibility
            function toggleSettings(event) {
                if (event) {
                    event.stopPropagation();
                }
                
                const isHidden = settingsPopup.classList.contains('hidden');
                console.log('Toggling Settings, currently hidden:', isHidden);
                
                if (isHidden) {
                    // Show settings
                    settingsPopup.classList.remove('hidden');
                    
                    // Hide other popups
                    const cofTooltip = document.getElementById('circle-of-fifths-tooltip');
                    const instructionsTooltip = document.getElementById('instructions-tooltip');
                    
                    if (cofTooltip) cofTooltip.classList.add('hidden');
                    if (instructionsTooltip) instructionsTooltip.classList.add('hidden');
                } else {
                    // Hide settings
                    settingsPopup.classList.add('hidden');
                }
            }
            
            // Setup event listeners
            if (settingsToggleButton) {
                settingsToggleButton.addEventListener('click', toggleSettings);
                console.log('Settings toggle button event listener added');
            }
            
            // Click outside to close
            document.addEventListener('click', function(event) {
                if (!settingsPopup.classList.contains('hidden') &&
                    !settingsPopup.contains(event.target) && 
                    event.target !== settingsToggleButton) {
                    settingsPopup.classList.add('hidden');
                }
            });
            
            // Add keyboard shortcut - 'S' for settings
            document.addEventListener('keydown', function(event) {
                if ((event.key === 's' || event.key === 'S') && 
                    document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    event.preventDefault();
                    toggleSettings();
                }
            });
            
            console.log('Simplified Settings popup setup complete');
        })();

        // Update the top bar creation to use the simpler approach
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Creating clean top bar...');
            
            // Remove any existing top bars
            const existingBar = document.querySelector('.top-bar');
            if (existingBar) existingBar.remove();
            
            // Create new top bar
            const topBar = document.createElement('div');
            topBar.className = 'top-bar';
            document.body.appendChild(topBar);
            
            // Create settings button
            const settingsButton = document.createElement('button');
            settingsButton.className = 'top-bar-button';
            settingsButton.innerHTML = '‚öôÔ∏è';
            settingsButton.addEventListener('click', function(event) {
                event.stopPropagation();
                const settingsPopup = document.getElementById('settings-popup');
                if (settingsPopup) {
                    settingsPopup.classList.toggle('hidden');
                    
                    // Hide other popups
                    const cofTooltip = document.getElementById('circle-of-fifths-tooltip');
                    const instructionsTooltip = document.getElementById('instructions-tooltip');
                    if (cofTooltip) cofTooltip.classList.add('hidden');
                    if (instructionsTooltip) instructionsTooltip.classList.add('hidden');
                }
            });
            topBar.appendChild(settingsButton);
            
            // Create theme button
            const themeButton = document.createElement('button');
            themeButton.className = 'top-bar-button';
            // Set initial theme icon
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            themeButton.innerHTML = `<span class="theme-icon">${currentTheme === 'dark' ? 'üåï' : 'üåë'}</span>`;
            
            themeButton.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeButton.innerHTML = `<span class="theme-icon">${newTheme === 'dark' ? 'üåï' : 'üåë'}</span>`;
            });
            topBar.appendChild(themeButton);
            
            // Create Circle of Fifths button
            const cofButton = document.createElement('button');
            cofButton.className = 'top-bar-button';
            cofButton.innerHTML = 'üéµ';
            cofButton.addEventListener('click', function(event) {
                event.stopPropagation();
                const cofTooltip = document.getElementById('circle-of-fifths-tooltip');
                if (cofTooltip) {
                    cofTooltip.classList.toggle('hidden');
                    
                    // Hide other popups
                    const settingsPopup = document.getElementById('settings-popup');
                    const instructionsTooltip = document.getElementById('instructions-tooltip');
                    if (settingsPopup) settingsPopup.classList.add('hidden');
                    if (instructionsTooltip) instructionsTooltip.classList.add('hidden');
                    
                    // Render circle if needed
                    if (!cofTooltip.classList.contains('hidden') && typeof renderCircleOfFifthsFixed === 'function') {
                        setTimeout(renderCircleOfFifthsFixed, 50);
                    }
                }
            });
            topBar.appendChild(cofButton);
            
            // Create help button
            const helpButton = document.createElement('button');
            helpButton.className = 'top-bar-button';
            helpButton.innerHTML = '‚ùì';
            helpButton.addEventListener('click', function(event) {
                event.stopPropagation();
                const instructionsTooltip = document.getElementById('instructions-tooltip');
                if (instructionsTooltip) {
                    instructionsTooltip.classList.toggle('hidden');
                    
                    // Hide other popups
                    const settingsPopup = document.getElementById('settings-popup');
                    const cofTooltip = document.getElementById('circle-of-fifths-tooltip');
                    if (settingsPopup) settingsPopup.classList.add('hidden');
                    if (cofTooltip) cofTooltip.classList.add('hidden');
                }
            });
            topBar.appendChild(helpButton);
            
            console.log('Clean top bar created with all buttons');
        });

        // Add to your main script, perhaps in the DOMContentLoaded event
        document.addEventListener('click', function() {
            // Initialize audio context on first user interaction
            if (typeof initAudioContext === 'function') {
                initAudioContext();
            }
        }, { once: true });

        // Also for spacebar and other key presses
        document.addEventListener('keydown', function() {
            if (typeof initAudioContext === 'function') {
                initAudioContext();
            }
        }, { once: true });

        // Then you can make them available to other scripts by adding them to the window object
        window.setCookie = setCookie;
        window.getCookie = getCookie;

        // Add this code to ensure all popups close when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            // Single event listener for all popups
            document.addEventListener('click', function(event) {
                // Get all popup elements
                const cofTooltip = document.getElementById('circle-of-fifths-tooltip');
                const instructionsTooltip = document.getElementById('instructions-tooltip');
                const settingsPopup = document.getElementById('settings-popup');
                
                // Get all toggle buttons
                const cofButton = document.querySelector('.top-bar-button:nth-child(3)'); // The Circle of Fifths button
                const helpButton = document.querySelector('.top-bar-button:nth-child(4)'); // The help button
                const settingsButton = document.querySelector('.top-bar-button:nth-child(1)'); // The settings button
                
                // Circle of Fifths - close if click is outside and not on the button
                if (cofTooltip && !cofTooltip.classList.contains('hidden') && 
                    !cofTooltip.contains(event.target) && 
                    event.target !== cofButton && 
                    (cofButton && !cofButton.contains(event.target))) {
                    cofTooltip.classList.add('hidden');
                    if (cofButton) cofButton.classList.remove('active');
                }
                
                // Instructions - close if click is outside and not on the button
                if (instructionsTooltip && !instructionsTooltip.classList.contains('hidden') && 
                    !instructionsTooltip.contains(event.target) && 
                    event.target !== helpButton && 
                    (helpButton && !helpButton.contains(event.target))) {
                    instructionsTooltip.classList.add('hidden');
                    if (helpButton) helpButton.classList.remove('active');
                }
                
                // Settings - close if click is outside and not on the button
                if (settingsPopup && !settingsPopup.classList.contains('hidden') && 
                    !settingsPopup.contains(event.target) && 
                    event.target !== settingsButton && 
                    (settingsButton && !settingsButton.contains(event.target))) {
                    settingsPopup.classList.add('hidden');
                    if (settingsButton) settingsButton.classList.remove('active');
                }
            });
            
            // Add active class to style buttons when their popups are open
            const style = document.createElement('style');
            style.textContent = `
                .top-bar-button.active {
                    background: rgba(0, 204, 153, 0.3);
                    box-shadow: 0 0 5px rgba(0, 204, 153, 0.5);
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
